<!DOCTYPE HTML>
<html lang="zh-CN" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>使用Kubernetes部署CnosDB集群 - CnosDB</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../../favicon.svg">
        <link rel="shortcut icon" href="../../../../favicon.png">
        <link rel="stylesheet" href="../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../css/general.css">
        <link rel="stylesheet" href="../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../../highlight.css">
        <link rel="stylesheet" href="../../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/about.html"><strong aria-hidden="true">1.</strong> 关于本项目</a></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/introduction/index.html"><strong aria-hidden="true">2.</strong> 介绍</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/introduction/download.html"><strong aria-hidden="true">2.1.</strong> 下载</a></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/introduction/install.html"><strong aria-hidden="true">2.2.</strong> 安装</a></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/introduction/get-start.html"><strong aria-hidden="true">2.3.</strong> 快速开始</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/concept/index.html"><strong aria-hidden="true">3.</strong> 概念</a></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/guide/index.html"><strong aria-hidden="true">4.</strong> 指南</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/guide/cnosdb.html"><strong aria-hidden="true">4.1.</strong> cnosdb</a></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/guide/cnosdb-cli.html"><strong aria-hidden="true">4.2.</strong> cnosdb-cli</a></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/guide/write.html"><strong aria-hidden="true">4.3.</strong> HTTP写入</a></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/guide/query.html"><strong aria-hidden="true">4.4.</strong> HTTP查询</a></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/guide/cnosdb_inspect.html"><strong aria-hidden="true">4.5.</strong> CnosDB Inspect</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/cnosql/index.html"><strong aria-hidden="true">5.</strong> CnosQL</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/cnosql/ddl.html"><strong aria-hidden="true">5.1.</strong> DDL</a></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/cnosql/dml.html"><strong aria-hidden="true">5.2.</strong> DML</a></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/cnosql/function.html"><strong aria-hidden="true">5.3.</strong> 函数</a></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/cnosql/countine_query.html"><strong aria-hidden="true">5.4.</strong> 连续查询</a></li></ol></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/cluster/introduction.html"><strong aria-hidden="true">6.</strong> CnosDB分布式</a></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/other/index.html"><strong aria-hidden="true">7.</strong> 其他</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/other/kubernetes-deployment.html"><strong aria-hidden="true">7.1.</strong> 使用Kubernetes部署CnosDB</a></li><li class="chapter-item expanded "><a href="../../../../content/cnosdb/0.10/other/kubernetes-StatefulSet.html" class="active"><strong aria-hidden="true">7.2.</strong> 使用Kubernetes部署CnosDB集群</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CnosDB</h1>

                    <div class="right-buttons">
                        <a href="../../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="使用kubernetes部署cnosdb集群"><a class="header" href="#使用kubernetes部署cnosdb集群">使用Kubernetes部署CnosDB集群</a></h1>
<h2 id="创建一个kubernetes-cnosdb部署文件"><a class="header" href="#创建一个kubernetes-cnosdb部署文件">创建一个Kubernetes CnosDB部署文件</a></h2>
<blockquote>
<p>下面的清单中包含两个<a href="https://kubernetes.io/zh/docs/concepts/services-networking/service/">Service</a>，两个<a href="https://kubernetes.io/zh/docs/concepts/configuration/configmap/https://kubernetes.io/zh/docs/concepts/configuration/configmap/">ConfigMap</a>，和两个<a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/statefulset/">StatefulSet</a>
本教程假设你的集群配置为动态的提供 PersistentVolumes。 如果你的集群没有配置成这样，在开始本教程前，你需要手动准备三个 20 GiB 和两个 2GiB 的卷。</p>
</blockquote>
<pre><code class="language-yaml">apiVersion: v1
kind: Service
metadata:
  name: cnosdb-meta
  labels:
    app: cnosdb-meta
spec:
  ports:
  - port: 8091
    name: meta
  selector:
    app: cnosdb-meta
---
apiVersion: v1
kind: Service
metadata:
  name: cnosdb-data
  labels:
    app: cnosdb-data
spec:
  type: LoadBalancer
  ports:
  - port: 8088
    name: data
  - port: 8086
    targetPort: 8086
    nodePort: 31086
    name: data-access
  selector:
    app: cnosdb-data
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: cnosdb-meta-pdb
spec:
  selector:
    matchLabels:
      app: cnosdb-meta
  maxUnavailable: 2
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: cnosdb-data-pdb
spec:
  selector:
    matchLabels:
      app: cnosdb-data
  maxUnavailable: 1
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cnosdb-meta-config
  labels:
    app: cnosdb-meta
data:
  cnosdb-meta.conf: |+
    dir = &quot;/var/lib/cnosdb/meta&quot;
    retention-autocreate = true
    hostname = &quot;&quot;
    [HTTPD]
      logging-enabled = true
      http-bind-address = &quot;:8091&quot;
      https-enabled = false
      https-certificate = &quot;&quot;
      election-timeout = &quot;1s&quot;
      heartbeat-timeout = &quot;1s&quot;
      leader-lease-timeout = &quot;500ms&quot;
      commit-timeout = &quot;50ms&quot;
      cluster-tracing = false
      lease-duration = &quot;1m0s&quot;
    [Log]
      level = &quot;INFO&quot;
      format = &quot;text&quot;
      disable-timestamp = false
      development = false
      disable-caller = false
      disable-stacktrace = false
      disable-error-verbose = false
    [Log.file]
      filename = &quot;&quot;
      max-size = 0
      max-days = 0
      max-backups = 0
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cnosdb-data-config
  labels:
    app: cnosdb-data
data:
  cnosdb-data.conf: |+
    bind-address = &quot;:8088&quot;
    cluster = true
    hostname = &quot;&quot;

    [Meta]
      dir = &quot;/var/lib/cnosdb/meta&quot;
      retention-autocreate = true

    [Data]
      dir = &quot;/var/lib/cnosdb/data&quot;
      index-version = &quot;tsi1&quot;
      wal-dir = &quot;/var/lib/cnosdb/wal&quot;
      wal-fsync-delay = &quot;0s&quot;
      validate-keys = false
      query-log-enabled = true
      cache-max-memory-size = 1073741824
      cache-snapshot-memory-size = 26214400
      cache-snapshot-write-cold-duration = &quot;10m0s&quot;
      compact-full-write-cold-duration = &quot;4h0m0s&quot;
      compact-throughput = 50331648
      compact-throughput-burst = 50331648
      max-series-per-database = 1000000
      max-values-per-tag = 100000
      max-concurrent-compactions = 0
      max-index-log-file-size = 1048576
      series-id-set-cache-size = 100
      trace-logging-enabled = false
      tsm-use-madv-willneed = false

    [Coordinator]
      force-remote-mapping = false
      write-timeout = &quot;10s&quot;
      shard-writer-timeout = &quot;5s&quot;
      max-remote-write-connections = 3
      shard-mapper-timeout = &quot;5s&quot;
      max-concurrent-queries = 0
      query-timeout = &quot;0s&quot;
      log-queries-after = &quot;0s&quot;
      max-select-point = 0
      max-select-series = 0
      max-select-buckets = 0

    [RetentionPolicy]
      enabled = true
      check-interval = &quot;30m0s&quot;

    [Precreator]
      enabled = true
      check-interval = &quot;10m0s&quot;
      advance-period = &quot;30m0s&quot;

    [Monitor]
      store-enabled = true
      store-database = &quot;_internal&quot;
      store-interval = &quot;10s&quot;

    [Subscriber]
      enabled = false
      http-timeout = &quot;0s&quot;
      insecure-skip-verify = false
      ca-certs = &quot;&quot;
      write-concurrency = 0
      write-buffer-size = 0

    [HTTPD]
      enabled = true
      bind-address = &quot;:8086&quot;
      auth-enabled = false
      log-enabled = true
      suppress-write-log = false
      write-tracing = false
      pprof-enabled = true
      debug-pprof-enabled = false
      https-enabled = false
      https-certificate = &quot;/etc/ssl/cnosdb.pem&quot;
      https-private-key = &quot;&quot;
      max-row-limit = 0
      max-connection-limit = 0
      shared-secret = &quot;&quot;
      realm = &quot;CnosDB&quot;
      unix-socket-enabled = false
      unix-socket-permissions = &quot;0777&quot;
      bind-socket = &quot;/var/run/cnosdb.sock&quot;
      max-body-size = 25000000
      access-log-path = &quot;&quot;
      max-concurrent-write-limit = 0
      max-enqueued-write-limit = 0
      enqueued-write-timeout = 30000000000

    [Log]
      level = &quot;INFO&quot;
      format = &quot;text&quot;
      disable-timestamp = false
      development = false
      disable-caller = false
      disable-stacktrace = false
      disable-error-verbose = false
    [Log.file]
      filename = &quot;&quot;
      max-size = 0
      max-days = 0
      max-backups = 0

    [ContinuousQuery]
      log-enabled = true
      enabled = true
      query-stats-enabled = false
      run-interval = &quot;1s&quot;

    [HintedHandoff]
      enabled = false
      dir = &quot;&quot;
      max-size = 0
      max-age = &quot;0s&quot;
      retry-rate-limit = 0
      retry-interval = &quot;0s&quot;
      retry-max-interval = &quot;0s&quot;
      purge-interval = &quot;0s&quot;

    [TLS]
      min-version = &quot;&quot;
      max-version = &quot;&quot;
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: cnosdb-meta
spec:
  selector:
    matchLabels:
      app: cnosdb-meta
  serviceName: cnosdb-meta
  replicas: 3
  updateStrategy:
    type: RollingUpdate
  podManagementPolicy: OrderedReady
  template:
    metadata:
      labels:
        app: cnosdb-meta
    spec:
      containers:
      - name: kubernetes-cnosdb-meta
        imagePullPolicy: Always
        image: &quot;cnosdb/cnosdb-meta:latest&quot;
        resources:
          requests:
            memory: &quot;2Gi&quot;
            cpu: &quot;2&quot;
        ports:
        - containerPort: 8091
          name: meta
        volumeMounts:
        - name: metadir
          mountPath: /var/lib/cnosdb
        - name: meta-config-volume
          mountPath: /etc/cnosdb/
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: CNOSDB_HOSTNAME
          value: &quot;$(POD_NAME).cnosdb-meta&quot;
      volumes:
        - name: meta-config-volume
          configMap:
            name: cnosdb-meta-config
  volumeClaimTemplates:
    - metadata:
        name: metadir
      spec:
        accessModes: [ &quot;ReadWriteOnce&quot; ]
        resources:
          requests:
            storage: 2Gi
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: cnosdb-data
spec:
  selector:
    matchLabels:
      app: cnosdb-data
  serviceName: cnosdb-data
  replicas: 2
  updateStrategy:
    type: RollingUpdate
  podManagementPolicy: OrderedReady
  template:
    metadata:
      labels:
        app: cnosdb-data
    spec:
      containers:
      - name: kubernetes-cnosdb-data
        imagePullPolicy: Always
        image: &quot;cnosdb/cnosdb-data:latest&quot;
        resources:
          requests:
            memory: &quot;8Gi&quot;
            cpu: &quot;4&quot;
        ports:
        - containerPort: 8088
          name: cnosdb-data
        - containerPort: 8086
          name: data-access
        volumeMounts:
        - name: datadir
          mountPath: /var/lib/cnosdb
        - name: data-config-volume
          mountPath: /etc/cnosdb/
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: CNOSDB_HOSTNAME
          value: &quot;$(POD_NAME).cnosdb-data&quot;
      volumes:
        - name: data-config-volume
          configMap:
            name: cnosdb-data-config
  volumeClaimTemplates:
    - metadata:
        name: datadir
      spec:
        accessModes: [ &quot;ReadWriteOnce&quot; ]
        resources:
          requests:
            storage: 20Gi
</code></pre>
<h2 id="按照清单部署应用"><a class="header" href="#按照清单部署应用">按照清单部署应用</a></h2>
<pre><code class="language-shell">kubectl apply -f cnosdb-cluster.yaml
</code></pre>
<h2 id="将meta-node加入到集群"><a class="header" href="#将meta-node加入到集群">将<code>meta node</code>加入到集群</a></h2>
<blockquote>
<p>使用<code>kubectl get pod</code>查看，当所有pod都处于Running时</p>
</blockquote>
<pre><code class="language-shell">for i in 0 1 2; do kubectl exec cnosdb-meta-0 -- cnosdb-ctl add-meta  cnosdb-meta-$i.cnosdb-meta:8091; done
</code></pre>
<h2 id="如果以上命令执行成功"><a class="header" href="#如果以上命令执行成功">如果以上命令执行成功</a></h2>
<pre><code class="language-shell">kubectl exec cnosdb-meta-0 -- cnosdb-ctl show
Data Nodes:
==========

Meta Nodes:
==========

1      cnosdb-meta-0.cnosdb-meta:8091
2      cnosdb-meta-1.cnosdb-meta:8091
3      cnosdb-meta-2.cnosdb-meta:8091

</code></pre>
<h2 id="将data-node加入到集群"><a class="header" href="#将data-node加入到集群">将<code>data node</code>加入到集群</a></h2>
<pre><code class="language-shell">for i in 0 1; do kubectl exec cnosdb-meta-0 -- cnosdb-ctl add-data  cnosdb-data-$i.cnosdb-data:8088; done
</code></pre>
<h2 id="如果以上命令执行成功-1"><a class="header" href="#如果以上命令执行成功-1">如果以上命令执行成功</a></h2>
<pre><code class="language-shell">kubectl exec cnosdb-meta-0 -n cnosdb-test -- cnosdb-ctl show
Data Nodes:
==========

4      cnosdb-data-0.cnosdb-data:8088
5      cnosdb-data-1.cnosdb-data:8088

Meta Nodes:
==========

1      cnosdb-meta-0.cnosdb-meta:8091
2      cnosdb-meta-1.cnosdb-meta:8091
3      cnosdb-meta-2.cnosdb-meta:8091

</code></pre>
<h2 id="测试服务是否可用"><a class="header" href="#测试服务是否可用">测试服务是否可用</a></h2>
<pre><code class="language-shell">curl -i -XPOST http://&lt;nodeIP&gt;:31086/query --data-urlencode &quot;q=CREATE DATABASE test_db&quot;
HTTP/1.1 200 OK
Content-Type: application/json
X-Request-Id: 41e2329b-6945-11ec-8001-0242ac110007
Date: Thu, 30 Dec 2021 07:51:12 GMT
Transfer-Encoding: chunked

{&quot;results&quot;:[{&quot;statement_id&quot;:0}]}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../../content/cnosdb/0.10/other/kubernetes-deployment.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../../content/cnosdb/0.10/other/kubernetes-deployment.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3000/__livereload");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../../../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
